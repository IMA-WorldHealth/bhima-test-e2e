#!/bin/bash

# Save the current 
HOME_DIR=$(pwd)

# Prevent test failures from stopping the script
set +e -o pipefail

export CHROME_BIN=`which chromium`
export CHROME_OPTIONS="--headless"

# Update BHIMA to latest master
cd /home/jenkins/builds/Bhima
git pull

# Update the testing environment
yarn
npx playwright install

# Modify the playwright configuration to avoid interactive display of errors via web page
# sed -i -e "s/outputFolder/open/g" playwright.config.js
# sed -i -e "s/results\/playwright-report/never/g" playwright.config.js

# Clean any old test results files and processes
npm run test:clean
pkill --uid bhima -f puppeteer || true
pkill --uid bhima -f node || true

# Run the regular tests
echo "================================================================================"
date
set +e
npm run test || true

# Run the end-to-end tests
echo "================================================================================"
date
set +e
export E2E_TEST_SERVER=1
export PWTEST_SKIP_TEST_OUTPUT=1
npm run test:e2e-all || true
echo "================================================================================"
date

# Clean up
pkill --uid bhima -f puppeteer || true
pkill --uid bhima -f node || true

# Show the summary
npm run test:show-results

# Save the artifacts for Jenkins
npm run test:show-results > results/summary.txt
zip -r results.zip results -x results/playwright-report/\*
cp -r results $HOME_DIR/
cp results.zip $HOME_DIR/
